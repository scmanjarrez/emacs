/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */
#include <sys/types.h>
#include <string.h>
#include <grp.h>
#include <pwd.h>
#include "servicio.h"

respuesta_gid_luids *
obtener_ugids_1_svc(char **argp, struct svc_req *rqstp)
{
	static respuesta_gid_luids  result;
	struct group *desc_group;
	struct passwd *desc_user;
	int tam=0, *uids;
	uids=calloc(1, sizeof(int));
	
	xdr_free((xdrproc_t)xdr_respuesta_gid_luids, (char *)&result);
	
	desc_group=getgrnam(*argp);

	if (desc_group)
	  {
	    result.gid=desc_group->gr_gid;

	    char **user_ids=desc_group->gr_mem;

	    while(*user_ids!=NULL)/* Get all uid and store it*/
	      {
		desc_user=getpwnam(*user_ids++);
		uids[tam++]=desc_user->pw_uid;
		uids=realloc(uids, (1+tam)*sizeof(int));
	      }
	    uids=realloc(uids, tam*sizeof(int));

	    result.uids.uids_len=tam;
	    result.uids.uids_val=malloc(tam*sizeof(int));
	    memcpy(result.uids.uids_val, uids, tam*sizeof(int));
	  }
	else
	  {
	    result.gid=-1;
	    result.uids.uids_len=0;
	    result.uids.uids_val=malloc(sizeof(int));
	  }
	
	free(uids);
	return &result;
}
